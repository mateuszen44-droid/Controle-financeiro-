<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Controle de Mateus e Thais</title>

  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- √çcone com cifr√£o (funciona no navegador; iPhone tela inicial √†s vezes pede PNG separado) -->
  <link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="%2366a8ff"/>
        <stop offset="1" stop-color="%2345e2a8"/>
      </linearGradient>
    </defs>
    <rect width="256" height="256" rx="56" fill="%230b1220"/>
    <rect x="18" y="18" width="220" height="220" rx="52" fill="url(%23g)" opacity="0.18"/>
    <circle cx="128" cy="128" r="74" fill="url(%23g)" opacity="0.16"/>
    <path d="M148 76c0-6-4-10-10-10h-6V56c0-5-4-8-8-8s-8 3-8 8v10h-7c-18 0-33 12-33 29 0 15 10 25 26 29l14 3c11 2 16 6 16 14 0 8-8 14-18 14h-23c-6 0-10 4-10 10s4 10 10 10h15v10c0 5 4 8 8 8s8-3 8-8v-10h8c20 0 35-12 35-30 0-16-11-26-28-30l-14-3c-10-2-14-6-14-12 0-8 7-13 17-13h21c6 0 10-4 10-10z"
      fill="%23eaf0ff"/>
  </svg>' />

  <!-- Se voc√™ j√° tem manifest/sw no repo, mant√©m funcionando -->
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    :root{
      --bg:#0b1220;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.10);
      --text: #eaf0ff;
      --muted:#a7b4d6;
      --good:#45e2a8;
      --bad:#ff6b6b;
      --accent:#66a8ff;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(102,168,255,.20), transparent 60%),
        radial-gradient(900px 600px at 110% 10%, rgba(69,226,168,.16), transparent 55%),
        linear-gradient(180deg, #09101f, var(--bg));
      padding: 18px 14px 110px;
      padding-bottom: calc(110px + env(safe-area-inset-bottom));
    }

    .wrap{max-width:900px;margin:0 auto}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding: 10px 6px 18px;
    }
    .title{
      font-size: 28px;
      font-weight: 900;
      letter-spacing: .2px;
      margin: 0;
    }
    .sub{
      margin:6px 0 0;
      color:rgba(234,240,255,.65);
      font-weight:700;
      font-size:12px;
    }

    .grid{display:grid;grid-template-columns: 1fr;gap: 14px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 16px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .12em;
      color: rgba(234,240,255,.78);
      font-weight: 900;
    }
    .card .bd{padding: 0 16px 16px;}

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 8px;
    }
    .kpi .box{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px;
      min-height: 76px;
    }
    .kpi .lbl{font-size:12px;color:var(--muted);font-weight:800}
    .kpi .val{font-size:20px;font-weight:950;margin-top:6px}
    .kpi .val.good{color:var(--good)}
    .kpi .val.bad{color:var(--bad)}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .form .full{grid-column: 1 / -1}

    input, select, textarea, button{font: inherit;color: var(--text);}
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      outline: none;
    }
    textarea{min-height: 84px; resize: vertical;}

    .btn{
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(102,168,255,.16);
      font-weight: 950;
      cursor: pointer;
    }
    .btn:active{transform: translateY(1px)}
    .btn.ghost{background: rgba(0,0,0,.18)}
    .btn.good{background: rgba(69,226,168,.18)}
    .btn.bad{background: rgba(255,107,107,.18)}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
    }
    th, td{
      padding: 10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size: 13px;
      text-align:left;
      vertical-align: top;
    }
    th{color:rgba(234,240,255,.75);font-weight:950}
    tr:last-child td{border-bottom:none}

    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-weight: 950;
      font-size: 12px;
      white-space: nowrap;
    }
    .tag.good{color:var(--good)}
    .tag.bad{color:var(--bad)}
    .tag.mid{color:rgba(234,240,255,.85)}

    .hide{display:none !important}

    .note{
      color: rgba(234,240,255,.72);
      font-size: 12px;
      margin-top: 10px;
      line-height: 1.4;
    }

    /* Tabs */
    .tabs{
      position: fixed;
      left: 0; right:0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(5,9,18,.75);
      backdrop-filter: blur(18px);
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .tabs .inner{
      max-width: 900px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .tab{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap: 6px;
      padding: 10px 8px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(234,240,255,.85);
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(102,168,255,.18);
      border-color: rgba(102,168,255,.32);
      color: #fff;
    }
    .tab .ico{font-size:18px;line-height:1}

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .progress{
      margin-top:8px;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(102,168,255,.65), rgba(69,226,168,.65));
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 class="title">Controle de Mateus e Thais</h1>
        <div class="sub">Brasil ‚Ä¢ sem senha ‚Ä¢ salvo no aparelho</div>
      </div>
    </div>

    <!-- P√ÅGINA: HOJE -->
    <section id="page-hoje" class="grid">
      <div class="card">
        <div class="hd"><h2>RESUMO</h2></div>
        <div class="bd">
          <div class="kpi">
            <div class="box">
              <div class="lbl">Saldo atual</div>
              <div id="kpi-saldo" class="val good">R$ 0,00</div>
            </div>
            <div class="box">
              <div class="lbl">Gastos (m√™s)</div>
              <div id="kpi-gastos" class="val bad">R$ 0,00</div>
            </div>
            <div class="box">
              <div class="lbl">Investimentos</div>
              <div id="kpi-invest" class="val">R$ 0,00</div>
            </div>
            <div class="box">
              <div class="lbl">Reserva emerg√™ncia</div>
              <div id="kpi-reserva" class="val">R$ 0,00</div>
            </div>
            <div class="box">
              <div class="lbl">Viagem final do ano</div>
              <div id="kpi-viagem" class="val">R$ 0,00</div>
            </div>
            <div class="box">
              <div class="lbl">Troca do carro</div>
              <div id="kpi-carro" class="val">R$ 0,00</div>
            </div>
          </div>

          <div class="btnbar">
            <button class="btn good" onclick="abrir('page-mov')">+ Adicionar</button>
            <button class="btn ghost" onclick="abrir('page-metas')">Metas / Caixinhas</button>
            <button class="btn ghost" onclick="abrir('page-config')">Config</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>√öLTIMOS LAN√áAMENTOS</h2></div>
        <div class="bd">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Categoria</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="tbl-ultimos">
              <tr><td colspan="4" style="color:rgba(234,240,255,.65)">Sem lan√ßamentos ainda.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- P√ÅGINA: MOVIMENTA√á√ïES -->
    <section id="page-mov" class="grid hide">
      <div class="card">
        <div class="hd"><h2>ADICIONAR ENTRADA / SA√çDA</h2></div>
        <div class="bd">
          <div class="form">
            <div>
              <select id="m-tipo" onchange="atualizarCategorias()">
                <option value="receita">Entrada (Receita)</option>
                <option value="gasto">Sa√≠da (Gasto)</option>
              </select>
            </div>
            <div>
              <input id="m-data" type="date" />
            </div>

            <div class="full">
              <select id="m-cat-select"></select>
            </div>

            <div class="full">
              <input id="m-cat-custom" placeholder="Ou escreva uma categoria (opcional)" />
            </div>

            <div class="full">
              <input id="m-valor" inputmode="decimal" placeholder="Valor (ex: 125,90)" />
            </div>

            <div class="full">
              <textarea id="m-nota" placeholder="Observa√ß√£o (opcional)"></textarea>
            </div>
          </div>

          <div class="btnbar">
            <button class="btn good" onclick="salvarMov()">Salvar</button>
            <button class="btn ghost" onclick="limparMov()">Limpar</button>
            <button class="btn bad" onclick="resetarTudo()">Resetar tudo</button>
          </div>

          <div class="note">
            ‚úÖ Agora tem categoria de <b>Entrada</b> e <b>Sa√≠da</b>. Troque o ‚ÄúTipo‚Äù e a lista muda.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>HIST√ìRICO</h2></div>
        <div class="bd">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Categoria</th>
                <th>Valor</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbl-hist"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- P√ÅGINA: METAS / CAIXINHAS -->
    <section id="page-metas" class="grid hide">
      <div class="card">
        <div class="hd"><h2>METAS / CAIXINHAS</h2></div>
        <div class="bd">
          <div class="form">
            <div class="full">
              <select id="c-dest">
                <option value="invest">Investimentos</option>
                <option value="reserva">Reserva de emerg√™ncia</option>
                <option value="viagem">Viagem final do ano</option>
                <option value="carro">Troca do carro</option>
              </select>
            </div>

            <div class="full">
              <input id="c-valor" inputmode="decimal" placeholder="Valor (ex: 200,00)" />
            </div>

            <div class="btnbar">
              <button class="btn good" onclick="guardar()">Guardar (tira do saldo)</button>
              <button class="btn ghost" onclick="resgatar()">Resgatar (volta pro saldo)</button>
            </div>

            <div class="full">
              <div class="note" style="margin-top:2px">
                Defina as metas (opcional). O app mostra o progresso.
              </div>
            </div>

            <div class="full row2">
              <input id="meta-invest" inputmode="decimal" placeholder="Meta Investimentos (ex: 10000,00)" />
              <button class="btn" onclick="salvarMeta('invest')">Salvar</button>

              <input id="meta-reserva" inputmode="decimal" placeholder="Meta Reserva (ex: 6000,00)" />
              <button class="btn" onclick="salvarMeta('reserva')">Salvar</button>

              <input id="meta-viagem" inputmode="decimal" placeholder="Meta Viagem (ex: 5000,00)" />
              <button class="btn" onclick="salvarMeta('viagem')">Salvar</button>

              <input id="meta-carro" inputmode="decimal" placeholder="Meta Carro (ex: 20000,00)" />
              <button class="btn" onclick="salvarMeta('carro')">Salvar</button>
            </div>
          </div>

          <div class="kpi" style="margin-top:12px">
            <div class="box">
              <div class="lbl">Investimentos</div>
              <div id="box-invest" class="val">R$ 0,00</div>
              <div class="note" id="note-invest">Meta: R$ 0,00</div>
              <div class="progress"><div id="bar-invest"></div></div>
            </div>

            <div class="box">
              <div class="lbl">Reserva emerg√™ncia</div>
              <div id="box-reserva" class="val">R$ 0,00</div>
              <div class="note" id="note-reserva">Meta: R$ 0,00</div>
              <div class="progress"><div id="bar-reserva"></div></div>
            </div>

            <div class="box">
              <div class="lbl">Viagem final do ano</div>
              <div id="box-viagem" class="val">R$ 0,00</div>
              <div class="note" id="note-viagem">Meta: R$ 0,00</div>
              <div class="progress"><div id="bar-viagem"></div></div>
            </div>

            <div class="box">
              <div class="lbl">Troca do carro</div>
              <div id="box-carro" class="val">R$ 0,00</div>
              <div class="note" id="note-carro">Meta: R$ 0,00</div>
              <div class="progress"><div id="bar-carro"></div></div>
            </div>
          </div>

          <div class="note">
            üí° ‚ÄúGuardar‚Äù tira do <b>saldo</b> e coloca na caixinha. ‚ÄúResgatar‚Äù faz o contr√°rio.
          </div>
        </div>
      </div>
    </section>

    <!-- P√ÅGINA: CONFIG -->
    <section id="page-config" class="grid hide">
      <div class="card">
        <div class="hd"><h2>CONFIGURA√á√ïES</h2></div>
        <div class="bd">
          <div class="form">
            <div class="full">
              <input id="saldo-inicial" inputmode="decimal" placeholder="Definir saldo (ex: 600,00)" />
            </div>
            <div class="btnbar">
              <button class="btn good" onclick="definirSaldo()">Salvar</button>
              <button class="btn ghost" onclick="exportar()">Exportar (JSON)</button>
              <button class="btn ghost" onclick="importar()">Importar (colar JSON)</button>
            </div>
          </div>

          <div class="note">
            Sem senha. Tudo fica salvo no aparelho.
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="inner">
      <div class="tab active" id="tab-hoje" onclick="abrir('page-hoje')"><div class="ico">üè†</div>Hoje</div>
      <div class="tab" id="tab-mov" onclick="abrir('page-mov')"><div class="ico">üßæ</div>Adicionar</div>
      <div class="tab" id="tab-metas" onclick="abrir('page-metas')"><div class="ico">üéØ</div>Metas</div>
      <div class="tab" id="tab-config" onclick="abrir('page-config')"><div class="ico">‚öôÔ∏è</div>Config</div>
    </div>
  </div>

  <script>
    // Service worker (se existir no repo)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
    }

    const BRL = new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" });
    const $ = (id) => document.getElementById(id);

    function parseBRL(v){
      if(!v) return 0;
      v = String(v).trim().replace(/\./g,"").replace(",",".").replace(/[^\d.\-]/g,"");
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function todayISO(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60000);
      return local.toISOString().slice(0,10);
    }
    function cryptoRandom(){
      try{
        const a = new Uint32Array(4);
        crypto.getRandomValues(a);
        return [...a].map(x=>x.toString(16)).join("-");
      }catch(e){
        return String(Date.now()) + "-" + Math.random().toString(16).slice(2);
      }
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // CATEGORIAS (ENTRADA e SA√çDA)
    const CATS_ENTRADA = [
      "Sal√°rio",
      "Pix recebido",
      "Venda",
      "Freela/Servi√ßo",
      "Reembolso",
      "Renda extra",
      "Presente",
      "Outros"
    ];

    const CATS_SAIDA = [
      "Mercado",
      "Restaurante/Lanche",
      "Gasolina/Transporte",
      "Conta de luz",
      "Conta de √°gua",
      "Internet/Telefone",
      "Aluguel",
      "Cart√£o de cr√©dito",
      "Sa√∫de",
      "Farm√°cia",
      "Lazer",
      "Educa√ß√£o",
      "Compras",
      "Assinaturas",
      "Outros"
    ];

    // STATE
    const KEY = "controle_mateus_thais_v2";
    function defaultState(){
      return {
        saldo: 0,
        gastosMes: 0,
        invest: 0,
        reserva: 0,
        viagem: 0,
        carro: 0,
        metas: { invest:0, reserva:0, viagem:0, carro:0 },
        movs: [] // {id,tipo,data,cat,valor,nota}
      };
    }
    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return defaultState();
        const st = Object.assign(defaultState(), JSON.parse(raw));

        // migra√ß√µes (se faltarem campos)
        st.metas = Object.assign({invest:0,reserva:0,viagem:0,carro:0}, st.metas || {});
        if(typeof st.carro !== "number") st.carro = 0;
        return st;
      }catch(e){
        return defaultState();
      }
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    let state = load();

    // UI Tabs
    function abrir(pageId){
      const pages = ["page-hoje","page-mov","page-metas","page-config"];
      pages.forEach(p => $(p).classList.toggle("hide", p !== pageId));

      const tabs = [
        ["tab-hoje","page-hoje"],
        ["tab-mov","page-mov"],
        ["tab-metas","page-metas"],
        ["tab-config","page-config"],
      ];
      tabs.forEach(([t,p]) => $(t).classList.toggle("active", p === pageId));
      render();
    }

    // categorias din√¢micas
    function atualizarCategorias(){
      const tipo = $("m-tipo").value;
      const sel = $("m-cat-select");
      const list = (tipo === "receita") ? CATS_ENTRADA : CATS_SAIDA;

      sel.innerHTML = list.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    // Movimenta√ß√µes
    function limparMov(){
      $("m-tipo").value = "receita";
      $("m-data").value = todayISO();
      atualizarCategorias();
      $("m-cat-custom").value = "";
      $("m-valor").value = "";
      $("m-nota").value = "";
    }

    function salvarMov(){
      const tipo = $("m-tipo").value; // receita | gasto
      const data = $("m-data").value || todayISO();

      const catCustom = ($("m-cat-custom").value || "").trim();
      const catSelect = $("m-cat-select").value;
      const cat = catCustom ? catCustom : (catSelect || "(sem categoria)");

      const valor = parseBRL($("m-valor").value);
      const nota = ($("m-nota").value || "").trim();

      if(valor <= 0){
        alert("Coloque um valor maior que zero.");
        return;
      }

      if(tipo === "receita"){
        state.saldo += valor;
      } else {
        state.saldo -= valor;
        state.gastosMes += valor;
      }

      state.movs.unshift({ id: cryptoRandom(), tipo, data, cat, valor, nota });
      save();
      limparMov();
      abrir("page-hoje");
    }

    function removerMov(id){
      const idx = state.movs.findIndex(m => m.id === id);
      if(idx === -1) return;
      const m = state.movs[idx];

      // desfaz
      if(m.tipo === "receita"){
        state.saldo -= m.valor;
      }else if(m.tipo === "gasto"){
        state.saldo += m.valor;
        state.gastosMes = Math.max(0, state.gastosMes - m.valor);
      }

      state.movs.splice(idx,1);
      save();
      render();
    }

    // Metas/Caixinhas
    function nomeDest(d){
      if(d==="invest") return "Investimentos";
      if(d==="reserva") return "Reserva de emerg√™ncia";
      if(d==="viagem") return "Viagem final do ano";
      return "Troca do carro";
    }

    function guardar(){
      const dest = $("c-dest").value;
      const v = parseBRL($("c-valor").value);
      if(v<=0){ alert("Coloque um valor."); return; }
      if(state.saldo < v){ alert("Saldo insuficiente."); return; }

      state.saldo -= v;
      state[dest] += v;

      state.movs.unshift({
        id: cryptoRandom(),
        tipo: "transfer",
        data: todayISO(),
        cat: `Guardar ‚Üí ${nomeDest(dest)}`,
        valor: v,
        nota: ""
      });

      $("c-valor").value = "";
      save();
      render();
    }

    function resgatar(){
      const dest = $("c-dest").value;
      const v = parseBRL($("c-valor").value);
      if(v<=0){ alert("Coloque um valor."); return; }
      if(state[dest] < v){ alert("Valor insuficiente nessa caixinha."); return; }

      state[dest] -= v;
      state.saldo += v;

      state.movs.unshift({
        id: cryptoRandom(),
        tipo: "transfer",
        data: todayISO(),
        cat: `Resgatar ‚Üê ${nomeDest(dest)}`,
        valor: v,
        nota: ""
      });

      $("c-valor").value = "";
      save();
      render();
    }

    function salvarMeta(k){
      const idMap = { invest:"meta-invest", reserva:"meta-reserva", viagem:"meta-viagem", carro:"meta-carro" };
      const inp = $(idMap[k]);
      const v = parseBRL(inp.value);
      state.metas[k] = Math.max(0, v);
      inp.value = "";
      save();
      render();
    }

    // Config
    function definirSaldo(){
      const v = parseBRL($("saldo-inicial").value);
      state.saldo = Math.max(0, v);
      $("saldo-inicial").value = "";
      save();
      render();
      abrir("page-hoje");
    }

    function exportar(){
      const txt = JSON.stringify(state, null, 2);
      navigator.clipboard?.writeText(txt).then(()=>{
        alert("Exportado e copiado (JSON).");
      }).catch(()=>{
        prompt("Copie o JSON:", txt);
      });
    }

    function importar(){
      const txt = prompt("Cole aqui o JSON exportado:");
      if(!txt) return;
      try{
        const obj = JSON.parse(txt);
        state = Object.assign(defaultState(), obj);
        state.metas = Object.assign({invest:0,reserva:0,viagem:0,carro:0}, state.metas || {});
        if(typeof state.carro !== "number") state.carro = 0;
        save();
        render();
        alert("Importado com sucesso.");
      }catch(e){
        alert("JSON inv√°lido.");
      }
    }

    function resetarTudo(){
      if(!confirm("Tem certeza? Isso apaga tudo.")) return;
      state = defaultState();
      save();
      render();
      abrir("page-hoje");
    }

    function badgeTipo(tipo){
      if(tipo === "receita") return `<span class="tag good">Entrada</span>`;
      if(tipo === "gasto") return `<span class="tag bad">Sa√≠da</span>`;
      return `<span class="tag mid">Transfer</span>`;
    }

    function pct(atual, meta){
      if(!meta || meta <= 0) return 0;
      return Math.max(0, Math.min(100, (atual/meta)*100));
    }

    function render(){
      // KPIs
      $("kpi-saldo").textContent = BRL.format(state.saldo);
      $("kpi-saldo").classList.toggle("bad", state.saldo < 0);
      $("kpi-saldo").classList.toggle("good", state.saldo >= 0);

      $("kpi-gastos").textContent = BRL.format(state.gastosMes);
      $("kpi-invest").textContent = BRL.format(state.invest);
      $("kpi-reserva").textContent = BRL.format(state.reserva);
      $("kpi-viagem").textContent = BRL.format(state.viagem);
      $("kpi-carro").textContent = BRL.format(state.carro);

      // Boxes metas
      $("box-invest").textContent = BRL.format(state.invest);
      $("box-reserva").textContent = BRL.format(state.reserva);
      $("box-viagem").textContent = BRL.format(state.viagem);
      $("box-carro").textContent = BRL.format(state.carro);

      $("note-invest").textContent = "Meta: " + BRL.format(state.metas.invest || 0);
      $("note-reserva").textContent = "Meta: " + BRL.format(state.metas.reserva || 0);
      $("note-viagem").textContent = "Meta: " + BRL.format(state.metas.viagem || 0);
      $("note-carro").textContent = "Meta: " + BRL.format(state.metas.carro || 0);

      $("bar-invest").style.width = pct(state.invest, state.metas.invest) + "%";
      $("bar-reserva").style.width = pct(state.reserva, state.metas.reserva) + "%";
      $("bar-viagem").style.width = pct(state.viagem, state.metas.viagem) + "%";
      $("bar-carro").style.width = pct(state.carro, state.metas.carro) + "%";

      // √öltimos
      const ult = state.movs.slice(0,6);
      $("tbl-ultimos").innerHTML = ult.length
        ? ult.map(m => `
          <tr>
            <td>${m.data}</td>
            <td>${badgeTipo(m.tipo)}</td>
            <td>${escapeHtml(m.cat)}</td>
            <td>${BRL.format(m.valor)}</td>
          </tr>
        `).join("")
        : `<tr><td colspan="4" style="color:rgba(234,240,255,.65)">Sem lan√ßamentos ainda.</td></tr>`;

      // Hist√≥rico
      $("tbl-hist").innerHTML = state.movs.length
        ? state.movs.map(m => `
          <tr>
            <td>${m.data}</td>
            <td>${badgeTipo(m.tipo)}</td>
            <td>${escapeHtml(m.cat)}${m.nota ? `<div class="note">${escapeHtml(m.nota)}</div>` : ""}</td>
            <td>${BRL.format(m.valor)}</td>
            <td><button class="btn bad" style="padding:8px 10px;border-radius:12px" onclick="removerMov('${m.id}')">X</button></td>
          </tr>
        `).join("")
        : `<tr><td colspan="5" style="color:rgba(234,240,255,.65)">Sem lan√ßamentos.</td></tr>`;
    }

    // Init
    (function init(){
      $("m-data").value = todayISO();
      atualizarCategorias();
      render();
    })();
  </script>
</body>
</html>
