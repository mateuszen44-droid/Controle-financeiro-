<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Controle Financeiro (Casal)</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.10);
      --text:#eaf0ff; --muted:#a7b4d6; --good:#31d07c; --bad:#ff5d7a; --accent:#4c8dff;
      --shadow:0 18px 60px rgba(0,0,0,.40); --r:18px; --tap:52px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(900px 450px at 10% 0%, rgba(76,141,255,.20), transparent 60%),
        radial-gradient(900px 450px at 90% 10%, rgba(49,208,124,.16), transparent 60%),
        radial-gradient(900px 450px at 60% 100%, rgba(255,93,122,.14), transparent 60%),
        var(--bg);
      padding-bottom: 94px;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 0}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 4px 14px; position:sticky;top:0;z-index:20;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(11,18,32,.86), rgba(11,18,32,.15));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(76,141,255,.95), rgba(49,208,124,.85));
      box-shadow: var(--shadow);
      display:grid;place-items:center;
      font-weight:1000;color:#08111f;
      flex:0 0 auto;
      position:relative;overflow:hidden;
    }
    .logo:after{
      content:"";position:absolute;inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 42%);
      transform: rotate(18deg);
    }
    h1{margin:0;font-size:16px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{margin-top:4px;color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;color:var(--muted);
      user-select:none;white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:99px;background:var(--good);box-shadow:0 0 0 6px rgba(49,208,124,.10)}
    .dot.off{background:#ffd166;box-shadow:0 0 0 6px rgba(255,209,102,.10)}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;align-items:start}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .card .hd h2{margin:0;font-size:14px;letter-spacing:.2px}
    .card .hd small{display:block;margin-top:4px;color:var(--muted);font-size:12px}
    .card .bd{padding:14px}

    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:520px){.kpis{grid-template-columns:1fr}}
    .kpi{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      min-height:88px;
    }
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{margin-top:8px;font-size:18px;font-weight:1000}
    .good{color:var(--good)} .bad{color:var(--bad)}
    .mono{font-family:var(--mono)}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}

    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:86px;resize:vertical}
    input::placeholder,textarea::placeholder{color: rgba(167,180,214,.65)}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1;min-width:160px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.two{grid-template-columns:1fr}}

    .btn{
      height: var(--tap);
      padding:0 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color: rgba(76,141,255,.35); background: rgba(76,141,255,.16)}
    .btn.ok{border-color: rgba(49,208,124,.35); background: rgba(49,208,124,.16)}
    .btn.danger{border-color: rgba(255,93,122,.30); background: rgba(255,93,122,.12)}
    .btn.small{height:42px;border-radius:12px;font-size:13px;padding:0 12px;flex:0}
    .btn.wide{width:100%}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .item .left{min-width:0}
    .item .title{margin:0;font-size:14px;font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .meta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);font-size:12px;white-space:nowrap;
    }
    .empty{
      padding:14px;border-radius:16px;
      background: rgba(0,0,0,.14);
      border:1px dashed rgba(255,255,255,.16);
      color:var(--muted);text-align:center;
    }

    .progressWrap{
      height:12px;border-radius:999px;background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .progressBar{
      height:100%;width:0%;
      background: linear-gradient(90deg, rgba(49,208,124,.85), rgba(76,141,255,.80));
    }
    .small{font-size:12px;color:rgba(234,240,255,.75);line-height:1.45}

    .view{display:none}
    .view.active{display:block}

    .tabs{
      position:fixed;left:0;right:0;bottom:0;z-index:50;
      background: rgba(10,16,30,.80);
      backdrop-filter: blur(14px);
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 10px calc(12px + env(safe-area-inset-bottom));
    }
    .tabs .bar{
      max-width:980px;margin:0 auto;
      display:grid;grid-template-columns:repeat(4,1fr);gap:8px;
    }
    .tab{
      height:56px;border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--muted);font-weight:1000;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
      cursor:pointer;user-select:none;font-size:11px;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active{background: rgba(76,141,255,.14);border-color: rgba(76,141,255,.35);color: var(--text)}
    .tab .ico{font-size:18px;line-height:1}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom: 96px;z-index:80;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 12px;border-radius:999px;
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      max-width: calc(100% - 24px);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      opacity:0;pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">$</div>
        <div class="titlebox">
          <h1 id="appTitle">Controle Financeiro (Casal)</h1>
          <div class="sub">Entradas ‚Ä¢ Sa√≠das ‚Ä¢ Caixinhas ‚Ä¢ Investimentos</div>
        </div>
      </div>
      <div class="pill" title="Conex√£o">
        <span class="dot" id="netDot"></span>
        <span id="netTxt">offline</span>
      </div>
    </header>

    <!-- RESUMO -->
    <section class="view active" id="view-resumo">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Resumo do m√™s</h2>
              <small id="monthLabel">‚Äî</small>
            </div>
            <div class="row" style="flex:0;gap:8px">
              <button class="btn small" id="prevMonth">‚óÄ</button>
              <button class="btn small" id="nextMonth">‚ñ∂</button>
            </div>
          </div>
          <div class="bd">
            <div class="kpis">
              <div class="kpi">
                <div class="t">Entradas</div>
                <div class="v good" id="kIncome">R$ 0,00</div>
              </div>
              <div class="kpi">
                <div class="t">Sa√≠das</div>
                <div class="v bad" id="kExpense">R$ 0,00</div>
              </div>
              <div class="kpi">
                <div class="t">Saldo (m√™s)</div>
                <div class="v" id="kNet">R$ 0,00</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div>
                <label>Filtro (tipo)</label>
                <select id="fTipo">
                  <option value="all">Todos</option>
                  <option value="income">Entradas</option>
                  <option value="expense">Sa√≠das</option>
                  <option value="transfer">Transfer√™ncias</option>
                </select>
              </div>
              <div>
                <label>Buscar</label>
                <input id="fBusca" placeholder="Ex: mercado, aluguel, sal√°rio..." />
              </div>
              <div style="min-width:220px">
                <label>A√ß√£o</label>
                <button class="btn primary wide" id="btnNovoLanc">Ôºã Novo lan√ßamento</button>
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="list" id="resumoList"></div>
            <div class="empty" id="resumoEmpty" style="display:none">Sem lan√ßamentos neste m√™s com esse filtro.</div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Caixinhas & Metas</h2>
              <small>Guardar dinheiro e acompanhar progresso</small>
            </div>
          </div>
          <div class="bd">
            <div class="two">
              <div>
                <label>Caixinha</label>
                <select id="boxDest"></select>
              </div>
              <div>
                <label>Valor (R$)</label>
                <input id="boxValue" inputmode="decimal" placeholder="Ex: 100" />
              </div>
            </div>
            <div class="row">
              <button class="btn ok" id="btnGuardar">Guardar</button>
              <button class="btn" id="btnResgatar">Resgatar</button>
              <button class="btn" id="btnIrCaixinhas">Abrir caixinhas</button>
            </div>

            <div class="divider"></div>
            <div id="boxesMini"></div>

            <div class="divider"></div>
            <div class="row">
              <button class="btn" id="btnExportJSON">‚¨á Backup</button>
              <button class="btn" id="btnImportJSON">‚¨Ü Importar</button>
              <button class="btn" id="btnExportCSV">CSV</button>
            </div>

            <div class="small" style="margin-top:10px">
              ‚úÖ Tudo fica salvo no celular. Para trocar de aparelho: exporte backup.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LAN√áAR -->
    <section class="view" id="view-lancar">
      <div class="card">
        <div class="hd">
          <div>
            <h2 id="formTitle">Novo lan√ßamento</h2>
            <small>Entrada / Sa√≠da / Transfer√™ncia</small>
          </div>
          <div class="row" style="flex:0;gap:8px">
            <button class="btn small" id="btnFormNovo">Novo</button>
            <button class="btn small danger" id="btnCancelEdit" style="display:none">Cancelar</button>
          </div>
        </div>

        <div class="bd">
          <div class="two">
            <div>
              <label>Tipo</label>
              <select id="tipo">
                <option value="expense">Sa√≠da (gasto)</option>
                <option value="income">Entrada (recebido)</option>
                <option value="transfer">Transfer√™ncia (caixinha)</option>
              </select>
            </div>
            <div>
              <label>Valor (R$)</label>
              <input id="valor" inputmode="decimal" placeholder="Ex: 120,50" />
            </div>
          </div>

          <div class="two">
            <div>
              <label>Categoria</label>
              <select id="categoria"></select>
              <div class="small" style="margin-top:8px">Ou escreva:</div>
              <input id="catLivre" placeholder="Ex: 13¬∫, Feira, Bico..." />
            </div>
            <div>
              <label>Data</label>
              <input id="data" type="date" />
              <div class="small" style="margin-top:8px">Observa√ß√£o curta</div>
              <input id="obsCurta" placeholder="Pix / cart√£o / dinheiro..." />
            </div>
          </div>

          <div>
            <label>Descri√ß√£o</label>
            <input id="desc" placeholder="Ex: Mercado, Aluguel, Sal√°rio..." />
          </div>

          <div>
            <label>Observa√ß√£o completa (opcional)</label>
            <textarea id="obs" placeholder="Detalhes..."></textarea>
          </div>

          <div class="row">
            <button class="btn primary" id="btnSalvar">Salvar</button>
            <button class="btn danger" id="btnExcluir" style="display:none">Excluir</button>
            <button class="btn" id="btnVoltar">Voltar</button>
          </div>

          <div class="divider"></div>
          <div class="small">
            Transfer√™ncia serve pra registrar guarda/resgate de caixinha (opcional).
          </div>
        </div>
      </div>
    </section>

    <!-- CAIXINHAS -->
    <section class="view" id="view-caixinhas">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Caixinhas</h2>
            <small>Metas e progresso</small>
          </div>
          <div class="row" style="flex:0;gap:8px">
            <button class="btn small" id="btnResetBoxes">Reiniciar</button>
            <button class="btn small" id="btnBackBoxes">Voltar</button>
          </div>
        </div>
        <div class="bd">
          <div class="two">
            <div>
              <label>Adicionar nova caixinha</label>
              <input id="newBoxName" placeholder="Ex: Reforma, Escola..." />
            </div>
            <div>
              <label>Meta (R$)</label>
              <input id="newBoxGoal" inputmode="decimal" placeholder="Ex: 3000" />
            </div>
          </div>
          <div class="row">
            <button class="btn primary" id="btnAddBox">Adicionar</button>
          </div>

          <div class="divider"></div>
          <div id="boxesList"></div>
        </div>
      </div>
    </section>

    <!-- LISTA -->
    <section class="view" id="view-lista">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Lista do m√™s</h2>
            <small id="listaMes">‚Äî</small>
          </div>
          <div class="row" style="flex:0;gap:8px">
            <button class="btn small" id="btnBackLista">Voltar</button>
          </div>
        </div>
        <div class="bd">
          <div class="two">
            <div>
              <label>Tipo</label>
              <select id="lTipo">
                <option value="all">Todos</option>
                <option value="income">Entradas</option>
                <option value="expense">Sa√≠das</option>
                <option value="transfer">Transfer√™ncias</option>
              </select>
            </div>
            <div>
              <label>Categoria</label>
              <select id="lCat">
                <option value="all">Todas</option>
              </select>
            </div>
          </div>

          <div class="two">
            <div>
              <label>Ordenar</label>
              <select id="lOrd">
                <option value="date_desc">Data (mais novo)</option>
                <option value="date_asc">Data (mais antigo)</option>
                <option value="amount_desc">Valor (maior)</option>
                <option value="amount_asc">Valor (menor)</option>
              </select>
            </div>
            <div>
              <label>Buscar</label>
              <input id="lBusca" placeholder="Buscar..." />
            </div>
          </div>

          <div class="row">
            <button class="btn" id="btnAplicarLista">Aplicar</button>
            <button class="btn danger" id="btnLimparLista">Limpar</button>
            <button class="btn primary" id="btnNovoLanc2">Ôºã Lan√ßar</button>
          </div>

          <div class="divider"></div>
          <div class="list" id="lista"></div>
          <div class="empty" id="listaEmpty" style="display:none">Sem lan√ßamentos encontrados.</div>
        </div>
      </div>
    </section>
  </div>

  <!-- TABS -->
  <nav class="tabs" aria-label="Navega√ß√£o">
    <div class="bar">
      <button class="tab active" data-go="resumo"><span class="ico">üè†</span><span>Resumo</span></button>
      <button class="tab" data-go="lancar"><span class="ico">‚ûï</span><span>Lan√ßar</span></button>
      <button class="tab" data-go="caixinhas"><span class="ico">üéØ</span><span>Caixinhas</span></button>
      <button class="tab" data-go="lista"><span class="ico">üßæ</span><span>Lista</span></button>
    </div>
  </nav>

  <div class="toast" id="toast">‚Äî</div>

  <script>
    // ===== Service Worker =====
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
    }

    // ===== Utils =====
    const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    const pad2 = (n)=> String(n).padStart(2,'0');
    const $ = (id)=> document.getElementById(id);

    function toast(msg){
      const t=$("toast");
      t.textContent=msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm=setTimeout(()=>t.classList.remove("show"),2200);
    }

    function todayISO(){
      const d=new Date();
      const off=d.getTimezoneOffset();
      const local=new Date(d.getTime()-off*60000);
      return local.toISOString().slice(0,10);
    }

    function ymKey(iso){ return iso.slice(0,7); }
    function ymToLabel(ym){
      const [y,m]=ym.split('-').map(Number);
      const nomes=['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
      return `${nomes[m-1]} de ${y}`;
    }
    function addMonths(ym,delta){
      const [y,m]=ym.split('-').map(Number);
      const d=new Date(y,m-1,1);
      d.setMonth(d.getMonth()+delta);
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    }

    function parseBRL(str){
      if(!str) return NaN;
      let s=String(str).trim().replace(/\s/g,'');
      s=s.replace(/\./g,'').replace(',','.');
      s=s.replace(/[^\d.\-]/g,'');
      const v=Number(s);
      return Number.isFinite(v) ? v : NaN;
    }

    function uid(){
      try{
        const a=new Uint32Array(2);
        crypto.getRandomValues(a);
        return a[0].toString(16)+a[1].toString(16);
      }catch(e){
        return Math.random().toString(16).slice(2)+Date.now().toString(16);
      }
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    function formatDateBR(iso){
      if(!iso) return '‚Äî';
      const [y,m,d]=iso.split('-');
      return `${d}/${m}/${y}`;
    }

    // ===== Network pill =====
    function netUpdate(){
      const on=navigator.onLine;
      $("netDot").classList.toggle("off", !on);
      $("netTxt").textContent= on ? "online" : "offline";
    }
    window.addEventListener("online", netUpdate);
    window.addEventListener("offline", netUpdate);
    netUpdate();

    // ===== Storage keys =====
    const KEY_TX='cf_casal_tx_v1';
    const KEY_CATS_IN='cf_casal_cats_in_v1';
    const KEY_CATS_OUT='cf_casal_cats_out_v1';
    const KEY_BOXES='cf_casal_boxes_v1';

    const DEFAULT_CATS_IN=['Sal√°rio','Freelance','Vendas','Reembolso','Renda extra','Presente','Outros'];
    const DEFAULT_CATS_OUT=['Mercado','Casa','Aluguel','Luz','√Ågua','Internet','Telefone','Combust√≠vel','Transporte','Sa√∫de','Farm√°cia','Lazer','Educa√ß√£o','Assinaturas','Igreja/Oferta','D√≠vidas','Outros'];

    const DEFAULT_BOXES=[
      {id:'reserva', name:'Reserva de emerg√™ncia', emoji:'üõü', goal:5000, saved:0},
      {id:'invest',  name:'Investimentos',        emoji:'üìà', goal:10000, saved:0},
      {id:'viagem',  name:'Viagem',               emoji:'‚úàÔ∏è', goal:3000, saved:0},
      {id:'carro',   name:'Troca do carro',       emoji:'üöó', goal:20000, saved:0},
    ];

    function loadJSON(key,fallback){
      try{
        const raw=localStorage.getItem(key);
        if(!raw) return fallback;
        const v=JSON.parse(raw);
        return v ?? fallback;
      }catch(e){ return fallback; }
    }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

    let tx = loadJSON(KEY_TX, []);
    let catsIn = loadJSON(KEY_CATS_IN, null);
    if(!Array.isArray(catsIn) || !catsIn.length){ catsIn=[...DEFAULT_CATS_IN]; saveJSON(KEY_CATS_IN,catsIn); }
    let catsOut = loadJSON(KEY_CATS_OUT, null);
    if(!Array.isArray(catsOut) || !catsOut.length){ catsOut=[...DEFAULT_CATS_OUT]; saveJSON(KEY_CATS_OUT,catsOut); }
    let boxes = loadJSON(KEY_BOXES, null);
    if(!Array.isArray(boxes) || !boxes.length){ boxes=DEFAULT_BOXES.map(b=>({...b})); saveJSON(KEY_BOXES,boxes); }

    let currentYM = ymKey(todayISO());
    let editId = null;

    // ===== Views / Tabs =====
    const views={
      resumo:$("view-resumo"),
      lancar:$("view-lancar"),
      caixinhas:$("view-caixinhas"),
      lista:$("view-lista"),
    };
    function setView(name){
      Object.values(views).forEach(v=>v.classList.remove("active"));
      views[name].classList.add("active");
      document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.go===name));
      if(name==='resumo') renderResumo();
      if(name==='caixinhas') renderBoxes();
      if(name==='lista') renderLista();
      window.scrollTo({top:0,behavior:"smooth"});
    }
    document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click",()=>setView(t.dataset.go)));

    // ===== Month nav =====
    $("prevMonth").addEventListener("click", ()=>{ currentYM=addMonths(currentYM,-1); renderResumo(); });
    $("nextMonth").addEventListener("click", ()=>{ currentYM=addMonths(currentYM,+1); renderResumo(); });

    // ===== Categories by type =====
    const selTipo=$("tipo"), selCat=$("categoria");
    function fillCategories(){
      const type=selTipo.value;
      let list=[];
      if(type==='income') list=catsIn;
      else if(type==='expense') list=catsOut;
      else list=['Transfer√™ncia','Guardar/Resgatar','Outros'];
      selCat.innerHTML='';
      list.forEach(c=>{
        const o=document.createElement("option");
        o.value=c; o.textContent=c;
        selCat.appendChild(o);
      });
    }
    selTipo.addEventListener("change", ()=>{ fillCategories(); $("catLivre").value=''; });

    // ===== Helpers for month list =====
    function monthItems(ym){ return tx.filter(x=>ymKey(x.date)===ym); }
    function calcTotals(items){
      let inc=0, exp=0, tr=0;
      items.forEach(x=>{
        if(x.type==='income') inc+=x.amount;
        else if(x.type==='expense') exp+=x.amount;
        else tr+=x.amount;
      });
      return {inc,exp,tr,net:inc-exp};
    }

    // ===== Form =====
    $("data").value=todayISO();

    function resetForm(){
      editId=null;
      $("formTitle").textContent="Novo lan√ßamento";
      $("btnCancelEdit").style.display="none";
      $("btnExcluir").style.display="none";
      selTipo.value="expense";
      fillCategories();
      $("valor").value="";
      $("data").value=todayISO();
      $("desc").value="";
      $("obsCurta").value="";
      $("obs").value="";
      $("catLivre").value="";
    }

    function loadToForm(id){
      const it=tx.find(x=>x.id===id);
      if(!it) return;
      editId=id;
      $("formTitle").textContent="Editar lan√ßamento";
      $("btnCancelEdit").style.display="inline-flex";
      $("btnExcluir").style.display="inline-flex";

      selTipo.value=it.type;
      fillCategories();

      $("valor").value=String(it.amount).replace('.',',');
      $("data").value=it.date;

      const cat=it.category||"";
      if(cat && [...selCat.options].some(o=>o.value===cat)){
        selCat.value=cat;
        $("catLivre").value="";
      }else{
        $("catLivre").value=cat;
      }

      $("desc").value=it.desc||"";
      $("obsCurta").value=it.quick||"";
      $("obs").value=it.note||"";
      setView("lancar");
      toast("Editando‚Ä¶");
    }

    $("btnFormNovo").addEventListener("click", ()=>{ resetForm(); toast("Novo"); });
    $("btnVoltar").addEventListener("click", ()=> setView("resumo"));
    $("btnCancelEdit").addEventListener("click", ()=>{ resetForm(); setView("resumo"); });

    $("btnSalvar").addEventListener("click", ()=>{
      const a=parseBRL($("valor").value);
      if(!Number.isFinite(a) || a<=0){ toast("Valor inv√°lido"); $("valor").focus(); return; }
      const d=$("data").value || todayISO();
      const desc=($("desc").value||"").trim();
      if(!desc){ toast("Coloque uma descri√ß√£o"); $("desc").focus(); return; }

      let cat=($("catLivre").value||"").trim() || (selCat.value||"");
      if(!cat) cat="Outros";

      const item={
        id: editId || uid(),
        type: selTipo.value,
        amount: Number(a),
        date: d,
        category: cat,
        desc,
        quick: ($("obsCurta").value||"").trim(),
        note: ($("obs").value||"").trim(),
        createdAt: Date.now()
      };

      if(editId) tx=tx.map(x=>x.id===editId?item:x);
      else tx.push(item);

      saveJSON(KEY_TX, tx);
      currentYM=ymKey(d);
      resetForm();
      toast("Salvo ‚úÖ");
      setView("resumo");
    });

    $("btnExcluir").addEventListener("click", ()=>{
      if(!editId) return;
      if(!confirm("Excluir este lan√ßamento?")) return;
      tx=tx.filter(x=>x.id!==editId);
      saveJSON(KEY_TX, tx);
      toast("Exclu√≠do");
      resetForm();
      setView("lista");
    });

    // ===== Resumo render =====
    $("btnNovoLanc").addEventListener("click", ()=>{ resetForm(); setView("lancar"); });
    $("btnNovoLanc2").addEventListener("click", ()=>{ resetForm(); setView("lancar"); });
    $("btnIrCaixinhas").addEventListener("click", ()=> setView("caixinhas"));

    $("fTipo").addEventListener("change", renderResumo);
    $("fBusca").addEventListener("input", renderResumo);

    function renderResumo(){
      $("monthLabel").textContent=ymToLabel(currentYM);
      $("listaMes").textContent=ymToLabel(currentYM);

      const base=monthItems(currentYM);
      const t=calcTotals(base);

      $("kIncome").textContent=BRL.format(t.inc);
      $("kExpense").textContent=BRL.format(t.exp);
      $("kNet").textContent=BRL.format(t.net);
      $("kNet").classList.toggle("good", t.net>0);
      $("kNet").classList.toggle("bad", t.net<0);

      renderBoxesMini();

      const tipoF=$("fTipo").value;
      const q=($("fBusca").value||"").trim().toLowerCase();

      let arr=[...base];
      if(tipoF!=="all") arr=arr.filter(x=>x.type===tipoF);
      if(q){
        arr=arr.filter(x=>
          (x.desc||"").toLowerCase().includes(q) ||
          (x.note||"").toLowerCase().includes(q) ||
          (x.quick||"").toLowerCase().includes(q) ||
          (x.category||"").toLowerCase().includes(q)
        );
      }
      arr.sort((a,b)=> b.date.localeCompare(a.date) || ((b.createdAt||0)-(a.createdAt||0)));

      const list=$("resumoList");
      list.innerHTML="";
      $("resumoEmpty").style.display = arr.length ? "none" : "block";

      arr.slice(0,8).forEach(x=>{
        const sign = x.type==="income" ? "+" : (x.type==="expense" ? "‚àí" : "‚Üî");
        const cls  = x.type==="income" ? "good" : (x.type==="expense" ? "bad" : "");
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`
          <div class="left">
            <div class="title">${escapeHtml(x.desc)}</div>
            <div class="meta">
              <span class="tag">${x.type==="income"?"Entrada":(x.type==="expense"?"Sa√≠da":"Transfer")}</span>
              <span class="tag">${escapeHtml(x.category||"")}</span>
              <span class="tag mono">${formatDateBR(x.date)}</span>
              ${x.quick?`<span class="tag" title="${escapeHtml(x.quick)}">üí¨ ${escapeHtml(x.quick)}</span>`:""}
              ${x.note?`<span class="tag" title="${escapeHtml(x.note)}">üìù obs</span>`:""}
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
            <div class="amount ${cls}">${sign} ${BRL.format(x.amount)}</div>
            <button class="btn small" data-edit="${x.id}">Editar</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("[data-edit]").forEach(b=>{
        b.onclick=()=>loadToForm(b.getAttribute("data-edit"));
      });
    }

    // ===== Boxes (caixinhas) =====
    const boxDest=$("boxDest");
    function fillBoxSelect(){
      boxDest.innerHTML="";
      boxes.forEach(b=>{
        const o=document.createElement("option");
        o.value=b.id;
        o.textContent=`${b.emoji} ${b.name}`;
        boxDest.appendChild(o);
      });
    }

    function findBox(id){ return boxes.find(b=>b.id===id); }

    function renderBoxesMini(){
      fillBoxSelect();
      const wrap=$("boxesMini");
      wrap.innerHTML="";
      boxes.forEach(b=>{
        const pct=b.goal>0 ? Math.min(100, Math.round((b.saved/b.goal)*100)) : 0;
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`
          <div class="left">
            <div class="title">${b.emoji} ${escapeHtml(b.name)}</div>
            <div class="meta">
              <span class="tag">Guardado: <b>${BRL.format(b.saved)}</b></span>
              <span class="tag">Meta: <b>${BRL.format(b.goal)}</b></span>
              <span class="tag"><b>${pct}%</b></span>
            </div>
            <div class="progressWrap" style="margin-top:10px">
              <div class="progressBar" style="width:${pct}%"></div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
            <button class="btn small" data-openbox="${b.id}">Abrir</button>
          </div>
        `;
        wrap.appendChild(div);
      });
      wrap.querySelectorAll("[data-openbox]").forEach(btn=>{
        btn.onclick=()=>setView("caixinhas");
      });
    }

    function adjustBox(id, amount){
      const b=findBox(id);
      if(!b) return false;
      const next=Number((Number(b.saved||0)+amount).toFixed(2));
      if(next<0) return false;
      b.saved=next;
      saveJSON(KEY_BOXES, boxes);
      return true;
    }

    $("btnGuardar").addEventListener("click", ()=>{
      const id=boxDest.value;
      const v=parseBRL($("boxValue").value);
      if(!Number.isFinite(v) || v<=0){ toast("Valor inv√°lido"); return; }
      adjustBox(id, v);
      $("boxValue").value="";
      toast("Guardado ‚úÖ");
      renderResumo();
    });

    $("btnResgatar").addEventListener("click", ()=>{
      const id=boxDest.value;
      const v=parseBRL($("boxValue").value);
      if(!Number.isFinite(v) || v<=0){ toast("Valor inv√°lido"); return; }
      const ok=adjustBox(id, -v);
      if(!ok){ toast("Sem saldo nessa caixinha"); return; }
      $("boxValue").value="";
      toast("Resgatado ‚úÖ");
      renderResumo();
    });

    // ===== Caixinhas screen =====
    function renderBoxes(){
      fillBoxSelect();

      const list=$("boxesList");
      list.innerHTML="";

      boxes.forEach(b=>{
        const pct=b.goal>0 ? Math.min(100, Math.round((b.saved/b.goal)*100)) : 0;

        const card=document.createElement("div");
        card.className="card";
        card.style.margin="0 0 12px 0";
        card.innerHTML=`
          <div class="hd">
            <div>
              <h2>${b.emoji} ${escapeHtml(b.name)}</h2>
              <small>Meta: <b>${BRL.format(b.goal)}</b> ‚Ä¢ Guardado: <b>${BRL.format(b.saved)}</b> ‚Ä¢ <b>${pct}%</b></small>
            </div>
          </div>
          <div class="bd">
            <div class="progressWrap">
              <div class="progressBar" style="width:${pct}%"></div>
            </div>

            <div style="height:12px"></div>

            <div class="two">
              <div>
                <label>Alterar meta (R$)</label>
                <input inputmode="decimal" placeholder="Ex: 3000" id="goal_${b.id}">
                <button class="btn primary wide" style="margin-top:10px" data-setgoal="${b.id}">Salvar meta</button>
              </div>
              <div>
                <label>Valor (R$)</label>
                <input inputmode="decimal" placeholder="Ex: 100" id="val_${b.id}">
                <div class="row">
                  <button class="btn ok" data-add="${b.id}">Adicionar</button>
                  <button class="btn" data-sub="${b.id}">Retirar</button>
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <button class="btn danger" data-delbox="${b.id}">Excluir caixinha</button>
            </div>
            <div class="small" style="margin-top:10px">‚ö†Ô∏è Excluir apaga essa caixinha (n√£o afeta seus lan√ßamentos).</div>
          </div>
        `;
        list.appendChild(card);
      });

      list.querySelectorAll("[data-setgoal]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-setgoal");
          const v=parseBRL($("goal_"+id).value);
          if(!Number.isFinite(v) || v<=0){ toast("Meta inv√°lida"); return; }
          const b=findBox(id);
          b.goal=Number(v.toFixed(2));
          saveJSON(KEY_BOXES, boxes);
          $("goal_"+id).value="";
          toast("Meta salva ‚úÖ");
          renderBoxes();
        };
      });

      list.querySelectorAll("[data-add]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-add");
          const v=parseBRL($("val_"+id).value);
          if(!Number.isFinite(v) || v<=0){ toast("Valor inv√°lido"); return; }
          adjustBox(id, v);
          $("val_"+id).value="";
          toast("Adicionado ‚úÖ");
          renderBoxes();
        };
      });

      list.querySelectorAll("[data-sub]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-sub");
          const v=parseBRL($("val_"+id).value);
          if(!Number.isFinite(v) || v<=0){ toast("Valor inv√°lido"); return; }
          const ok=adjustBox(id, -v);
          if(!ok){ toast("Sem saldo nessa caixinha"); return; }
          $("val_"+id).value="";
          toast("Retirado ‚úÖ");
          renderBoxes();
        };
      });

      list.querySelectorAll("[data-delbox]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-delbox");
          const b=findBox(id);
          if(!b) return;
          if(!confirm(`Excluir a caixinha "${b.name}"?`)) return;
          boxes=boxes.filter(x=>x.id!==id);
          if(!boxes.length) boxes=DEFAULT_BOXES.map(x=>({...x}));
          saveJSON(KEY_BOXES, boxes);
          toast("Exclu√≠da");
          renderBoxes();
        };
      });
    }

    $("btnBackBoxes").addEventListener("click", ()=> setView("resumo"));
    $("btnResetBoxes").addEventListener("click", ()=>{
      if(!confirm("Reiniciar caixinhas? (volta padr√£o e zera valores)")) return;
      boxes=DEFAULT_BOXES.map(b=>({...b}));
      saveJSON(KEY_BOXES, boxes);
      toast("Reiniciado");
      renderBoxes();
    });

    $("btnAddBox").addEventListener("click", ()=>{
      const name=($("newBoxName").value||"").trim();
      const goal=parseBRL($("newBoxGoal").value);
      if(!name){ toast("Nome da caixinha"); return; }
      if(!Number.isFinite(goal) || goal<=0){ toast("Meta inv√°lida"); return; }
      boxes.push({id:uid(), name, emoji:"üí∞", goal:Number(goal.toFixed(2)), saved:0});
      saveJSON(KEY_BOXES, boxes);
      $("newBoxName").value=""; $("newBoxGoal").value="";
      toast("Caixinha criada ‚úÖ");
      renderBoxes();
    });

    // ===== Lista screen =====
    const lCat=$("lCat");
    function fillListaCats(){
      lCat.innerHTML='<option value="all">Todas</option>';
      const uniq=new Set(monthItems(currentYM).map(x=>x.category||"").filter(Boolean));
      [...uniq].sort((a,b)=>a.localeCompare(b,'pt-BR')).forEach(c=>{
        const o=document.createElement("option");
        o.value=c; o.textContent=c;
        lCat.appendChild(o);
      });
    }

    function renderLista(){
      $("listaMes").textContent=ymToLabel(currentYM);
      fillListaCats();

      const base=monthItems(currentYM);
      let arr=[...base];

      const t=$("lTipo").value, c=$("lCat").value, q=($("lBusca").value||"").trim().toLowerCase();
      if(t!=="all") arr=arr.filter(x=>x.type===t);
      if(c!=="all") arr=arr.filter(x=>(x.category||"")===c);
      if(q){
        arr=arr.filter(x=>
          (x.desc||"").toLowerCase().includes(q) ||
          (x.note||"").toLowerCase().includes(q) ||
          (x.quick||"").toLowerCase().includes(q) ||
          (x.category||"").toLowerCase().includes(q)
        );
      }

      const ord=$("lOrd").value;
      arr.sort((a,b)=>{
        if(ord==="date_desc") return b.date.localeCompare(a.date) || ((b.createdAt||0)-(a.createdAt||0));
        if(ord==="date_asc") return a.date.localeCompare(b.date) || ((a.createdAt||0)-(b.createdAt||0));
        if(ord==="amount_desc") return (b.amount-a.amount) || b.date.localeCompare(a.date);
        if(ord==="amount_asc") return (a.amount-b.amount) || b.date.localeCompare(a.date);
        return 0;
      });

      const list=$("lista");
      list.innerHTML="";
      $("listaEmpty").style.display = arr.length ? "none" : "block";

      arr.forEach(x=>{
        const sign=x.type==="income"?"+":(x.type==="expense"?"‚àí":"‚Üî");
        const cls=x.type==="income"?"good":(x.type==="expense"?"bad":"");
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`
          <div class="left">
            <div class="title">${escapeHtml(x.desc)}</div>
            <div class="meta">
              <span class="tag">${x.type==="income"?"Entrada":(x.type==="expense"?"Sa√≠da":"Transfer")}</span>
              <span class="tag">${escapeHtml(x.category||"")}</span>
              <span class="tag mono">${formatDateBR(x.date)}</span>
              ${x.quick?`<span class="tag" title="${escapeHtml(x.quick)}">üí¨ ${escapeHtml(x.quick)}</span>`:""}
              ${x.note?`<span class="tag" title="${escapeHtml(x.note)}">üìù obs</span>`:""}
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
            <div class="amount ${cls}">${sign} ${BRL.format(x.amount)}</div>
            <button class="btn small" data-edit="${x.id}">Editar</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("[data-edit]").forEach(b=>b.onclick=()=>loadToForm(b.getAttribute("data-edit")));
    }

    $("btnBackLista").addEventListener("click", ()=> setView("resumo"));
    $("btnAplicarLista").addEventListener("click", ()=>{ toast("Aplicado"); renderLista(); });
    $("btnLimparLista").addEventListener("click", ()=>{
      $("lTipo").value="all"; $("lCat").value="all"; $("lOrd").value="date_desc"; $("lBusca").value="";
      toast("Limpo"); renderLista();
    });
    $("lTipo").addEventListener("change", renderLista);
    $("lCat").addEventListener("change", renderLista);
    $("lOrd").addEventListener("change", renderLista);
    $("lBusca").addEventListener("input", renderLista);

    // ===== Export / Import =====
    function downloadFile(name, content, mime){
      const blob=new Blob([content],{type:mime});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=name;
      document.body.appendChild(a);
      a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function pickFile(accept){
      return new Promise((resolve)=>{
        const input=document.createElement("input");
        input.type="file";
        input.accept=accept;
        input.onchange=()=>resolve(input.files && input.files[0] ? input.files[0] : null);
        input.click();
      });
    }

    $("btnExportJSON").addEventListener("click", ()=>{
      const payload={
        app:"Controle Financeiro (Casal)",
        version:1,
        exportedAt:new Date().toISOString(),
        tx, catsIn, catsOut, boxes
      };
      downloadFile(`backup-controle-casal-${todayISO()}.json`, JSON.stringify(payload,null,2), "application/json");
      toast("Backup exportado");
    });

    $("btnImportJSON").addEventListener("click", async ()=>{
      const file=await pickFile(".json,application/json");
      if(!file) return;
      try{
        const data=JSON.parse(await file.text());
        if(!data || !Array.isArray(data.tx)) { alert("Backup inv√°lido."); return; }
        if(!confirm("Importar backup? Isso substitui seus dados atuais.")) return;

        tx = data.tx || [];
        catsIn = Array.isArray(data.catsIn)&&data.catsIn.length ? data.catsIn : [...DEFAULT_CATS_IN];
        catsOut = Array.isArray(data.catsOut)&&data.catsOut.length ? data.catsOut : [...DEFAULT_CATS_OUT];
        boxes = Array.isArray(data.boxes)&&data.boxes.length ? data.boxes : DEFAULT_BOXES.map(b=>({...b}));

        saveJSON(KEY_TX, tx);
        saveJSON(KEY_CATS_IN, catsIn);
        saveJSON(KEY_CATS_OUT, catsOut);
        saveJSON(KEY_BOXES, boxes);

        fillCategories();
        toast("Importado ‚úÖ");
        setView("resumo");
      }catch(e){
        alert("JSON inv√°lido.");
      }
    });

    $("btnExportCSV").addEventListener("click", ()=>{
      const rows=[["tipo","valor","data","categoria","descricao","obs_curta","observacao"]];
      tx.filter(t=>ymKey(t.date)===currentYM)
        .slice()
        .sort((a,b)=>a.date.localeCompare(b.date))
        .forEach(t=>{
          rows.push([
            t.type==="income"?"entrada":(t.type==="expense"?"saida":"transfer"),
            String(t.amount).replace(".",","),
            formatDateBR(t.date),
            t.category||"",
            t.desc||"",
            t.quick||"",
            (t.note||"").replace(/\n/g," ")
          ]);
        });

      const csv=rows.map(r=>r.map(cell=>{
        const s=String(cell??"");
        const needs=/[;"\n]/.test(s);
        const esc=s.replace(/"/g,'""');
        return needs ? `"${esc}"` : esc;
      }).join(";")).join("\n");

      downloadFile(`controle-casal-${currentYM}.csv`, csv, "text/csv;charset=utf-8");
      toast("CSV gerado");
    });

    // ===== Buttons shortcuts =====
    $("btnNovoLanc").addEventListener("click", ()=>{ resetForm(); setView("lancar"); });
    $("btnNovoLanc2").addEventListener("click", ()=>{ resetForm(); setView("lancar"); });

    // ===== Init =====
    fillCategories();
    fillBoxSelect();
    resetForm();
    renderResumo();
  </script>
</body>
</html>
